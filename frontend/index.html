<!DOCTYPE html>
<html lang="en">
<head>
    <!-- (ہیڈ کا مواد ویسے ہی رہے گا) -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - ScalpMaster AI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Teko:wght@500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* (سی ایس ایس کا مواد ویسے ہی رہے گا) */
    </style>
</head>
<body>

    <!-- (ہیڈر اور مین کنٹینر کا HTML ویسا ہی رہے گا) -->

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const signalsGrid = document.getElementById('signals-grid');
            const noSignalsMessage = document.getElementById('no-signals-message');
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            
            let signals = new Map();

            function renderSignals() {
                if (signals.size === 0) {
                    signalsGrid.style.display = 'none';
                    noSignalsMessage.style.display = 'block';
                } else {
                    signalsGrid.innerHTML = '';
                    signalsGrid.style.display = 'grid';
                    noSignalsMessage.style.display = 'none';
                    
                    const sortedSignals = Array.from(signals.values()).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    sortedSignals.forEach(signal => {
                        const card = createSignalCard(signal);
                        signalsGrid.appendChild(card);
                    });
                }
            }

            function createSignalCard(signal) {
                const card = document.createElement('div');
                card.className = 'signal-card';
                card.id = `signal-${signal.signal_id}`;
                const signalType = signal.signal_type.toLowerCase(); // ★★★ signal سے signal_type میں تبدیل کیا گیا
                const tagClass = signalType === 'buy' ? 'tag-buy' : 'tag-sell';
                const confidence = parseFloat(signal.confidence);

                card.innerHTML = `
                    <div class="signal-card-header">
                        <div>
                            <p class="signal-pair">${signal.symbol}</p>
                            <p style="color: var(--text-secondary); margin:0;">${signal.timeframe}</p>
                        </div>
                        <div class="signal-tag ${tagClass}">${signalType.toUpperCase()}</div>
                    </div>
                    <div class="confidence-circle" style="background: conic-gradient(var(--accent-gold) ${confidence * 3.6}deg, var(--secondary) 0deg);">
                        <div class="confidence-value">${confidence.toFixed(0)}%</div>
                    </div>
                    <div class="signal-details">
                        <p>Entry Price: <span>${signal.entry_price.toFixed(5)}</span></p>
                        <p>Take Profit: <span>${signal.tp_price.toFixed(5)}</span></p>
                        <p>Stop Loss: <span>${signal.sl_price.toFixed(5)}</span></p>
                    </div>
                `;
                return card;
            }

            function removeSignalCard(signalId) {
                const cardToRemove = document.getElementById(`signal-${signalId}`);
                if (cardToRemove) {
                    cardToRemove.classList.add('closing');
                    setTimeout(() => {
                        signals.delete(signalId);
                        renderSignals();
                    }, 500);
                }
            }

            // ★★★ نیا فنکشن ★★★
            async function fetchActiveSignals() {
                try {
                    const response = await fetch('/api/active-signals');
                    if (!response.ok) throw new Error('Failed to fetch active signals');
                    const activeSignals = await response.json();
                    
                    activeSignals.forEach(signal => {
                        if (!signals.has(signal.signal_id)) {
                            signals.set(signal.signal_id, signal);
                        }
                    });
                    renderSignals();
                } catch (error) {
                    console.error('Error fetching active signals:', error);
                }
            }

            function connectWebSocket() {
                const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${wsProtocol}//${window.location.host}/ws/live-signals`;
                const socket = new WebSocket(wsUrl);

                socket.onopen = () => {
                    statusDot.classList.add('connected');
                    statusText.textContent = 'Live';
                };

                socket.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    const signalData = message.data;

                    if (message.type === 'new_signal') {
                        if (!signals.has(signalData.signal_id)) {
                            signals.set(signalData.signal_id, signalData);
                            renderSignals();
                        }
                    } else if (message.type === 'signal_updated') {
                        if (signals.has(signalData.signal_id)) {
                            signals.set(signalData.signal_id, signalData);
                            renderSignals(); // اپ ڈیٹ شدہ کارڈ دکھانے کے لیے دوبارہ رینڈر کریں
                        }
                    } else if (message.type === 'signal_closed') {
                        if (signals.has(signalData.signal_id)) {
                            removeSignalCard(signalData.signal_id);
                        }
                    }
                };

                socket.onclose = () => {
                    statusDot.classList.remove('connected');
                    statusText.textContent = 'Reconnecting...';
                    setTimeout(connectWebSocket, 5000);
                };

                socket.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    socket.close();
                };
            }

            // صفحہ لوڈ ہوتے ہی فعال سگنلز حاصل کریں
            fetchActiveSignals();
            // پھر WebSocket کنکشن قائم کریں
            connectWebSocket();
        });
    </script>

</body>
</html>
