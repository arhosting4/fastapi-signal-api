<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScalpMaster AI</title>
    <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.0.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body { font-family: sans-serif; background-color: #111; color: #fff; padding: 20px; }
        #chart-container { width: 100%; height: 400px; margin-top: 20px; border: 1px solid #333; }
        #signal-info { margin-top: 20px; border: 1px solid #555; padding: 10px; }
        #error-log { margin-top: 20px; border: 1px solid red; padding: 10px; color: red; display: none; }
    </style>
</head>
<body>

    <h1>ScalpMaster AI</h1>
    
    <div>
        <input type="text" id="symbolInput" placeholder="e.g., EUR/USD" value="XAU/USD">
        <button id="fetchSignalBtn">Fetch Signal</button>
    </div>

    <div id="signal-info">
        <p>Waiting for signal...</p>
    </div>

    <div id="chart-container"></div>

    <div id="error-log"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            const symbolInput = document.getElementById('symbolInput');
            const fetchSignalBtn = document.getElementById('fetchSignalBtn');
            const signalInfo = document.getElementById('signal-info');
            const chartContainer = document.getElementById('chart-container');
            const errorLog = document.getElementById('error-log');
            let chart = null;

            function logError(message) {
                console.error(message);
                errorLog.style.display = 'block';
                errorLog.innerHTML = `<p>${message}</p>`;
            }

            const createChart = (candleData) => {
                try {
                    if (!window.LightweightCharts) throw new Error("LightweightCharts library is not loaded.");
                    if (!candleData || candleData.length === 0) throw new Error("No candle data received.");

                    chartContainer.innerHTML = '';
                    if (chart) chart.remove();

                    chart = LightweightCharts.createChart(chartContainer, {
                        width: chartContainer.clientWidth,
                        height: 400,
                        layout: { backgroundColor: '#111', textColor: '#fff' },
                        grid: { vertLines: { color: '#333' }, horzLines: { color: '#333' } },
                        crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                        
                        // *** اہم تبدیلی: قیمت اور وقت کے اسکیل کو فعال کریں ***
                        priceScale: {
                            borderColor: '#787B86',
                        },
                        timeScale: {
                            borderColor: '#787B86',
                            timeVisible: true,
                            secondsVisible: false,
                        },
                    });

                    const candleSeries = chart.addCandlestickSeries({
                        upColor: '#26a69a', downColor: '#ef5350', borderVisible: false,
                        wickUpColor: '#26a69a', wickDownColor: '#ef5350',
                    });
                    
                    const formattedData = candleData.map(d => ({
                        time: new Date(d.datetime + 'Z').getTime() / 1000,
                        open: d.open, high: d.high, low: d.low, close: d.close
                    }));
                    
                    candleSeries.setData(formattedData);
                    signalInfo.innerHTML += '<p style="color: #26a69a;">Chart created successfully!</p>';

                } catch (e) {
                    logError(`Chart creation failed: ${e.message}`);
                }
            };

            const fetchSignal = async () => {
                const symbol = symbolInput.value.trim();
                if (!symbol) return;

                signalInfo.innerHTML = `<p>Fetching data for ${symbol}...</p>`;
                errorLog.style.display = 'none';
                errorLog.innerHTML = '';

                try {
                    const response = await fetch(`/signal?symbol=${symbol}&timeframe=5min`);
                    if (!response.ok) throw new Error(`API request failed: ${response.statusText}`);
                    
                    const data = await response.json();
                    
                    signalInfo.innerHTML = `
                        <p>Symbol: ${data.symbol}</p>
                        <p>Signal: ${data.signal}</p>
                        <p>Confidence: ${data.confidence}%</p>
                    `;
                    createChart(data.candles);

                } catch (e) {
                    logError(`Fetch failed: ${e.message}`);
                }
            };

            fetchSignalBtn.addEventListener('click', fetchSignal);
        });
    </script>

</body>
</html>
